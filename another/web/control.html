<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>ESP32 Remote-Tank</title>
	<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div class="container">
		<div class="main-container">
			<div class="left-display" id="left-display"></div>
			<h2 class="title">ESP32 Remote-Tank</h2>
			<div class="right-display">
				<div>
					<p>CPU: <span id="cpu">disconnect</span></p>
					<p>MEM: <span id="mem">disconnect</span></p>
					<p>FPS: <span id="fps">disconnect</span></p>
					<p>BAT: <span id="bat">disconnect</span></p>
				</div>
			</div>
		</div>
		<div class="joystick">
			<div id="left-joystick"></div>
			<div class="button-container">
				<button id="start-button">start</button>
				<button id="reboot-button">reboot</button>
			</div>
			<div id="right-joystick"></div>
		</div>
	</div>

	<div id="camera-off">
		<h1>SYSTEM OFF</h1>
	</div>
	<div id="video"></div>
</body>

<script src=" https://cdn.jsdelivr.net/npm/nipplejs@0.10.2/dist/nipplejs.min.js "></script>
<script src="display.js"></script>
<script src="joystick.js"></script>
<script src="websocket.js"></script>
<script>
	const toggleButton = document.getElementById("start-button");
	const rebootButton = document.getElementById("reboot-button");
	const cameraOff = document.getElementById("camera-off");
	const videoContainer = document.getElementById("video");

	const cpuInfo = document.getElementById("cpu");
	const memInfo = document.getElementById("mem");
	const fpsInfo = document.getElementById("fps");
	const batInfo = document.getElementById("bat");

	let status = false;
	const rotation = 0;
	let ws = null;
	let img = null;
	let fpsArr = new Array;
	let fpsCal = null;

	toggleButton.addEventListener("click", () => {
		status = !status;

		if (status) {
			open();
		} else {
			close();
		}
	});

	function sendReboot(ws, retries = 50, interval = 10) {
		let count = 0;
		let confirmed = false;

		const handler = (event) => {
			let info;
			try { info = JSON.parse(event.data); } catch (e) { info = event.data; }

			if (info === "confirm") {
				confirmed = true;
				ws.removeEventListener('message', handler);
			}
		};

		ws.addEventListener('message', handler);

		const sendLoop = () => {
			if (confirmed) return;
			if (count >= retries) {
				ws.removeEventListener('message', handler);
				return;
			}

			ws.send('["reboot"]');
			count++;
			setTimeout(sendLoop, interval);
		};

		sendLoop();
	}

	rebootButton.addEventListener("click", async () => {
		if (!ws || ws.readyState !== WebSocket.OPEN) return;

		status = false;

		rebootButton.disabled = true;
		toggleButton.disabled = true;
		producer("System reboot... Finished in 5 seconds.");

		sendReboot(ws);

		close();

		await wait(5000);

		rebootButton.disabled = false;
		toggleButton.disabled = false;
		producer("System reboot finished");
	});

	function open() {
		elementInit();

		ws = createWebSocket("192.168.2.132", "81");

		fpsCal = setInterval(() => {
			if (fpsArr.length > 3) {
				const ms = fpsArr[fpsArr.length - 1] - fpsArr[0];

				const fps = (fpsArr.length / ms) * 1000;

				fpsInfo.innerText = `${fps.toFixed(2)}`;
				fpsArr.shift();
			}
		}, 500);
	}

	function elementInit() {
		toggleButton.innerText = "finish";

		cameraOff.style.zIndex = "-100";

		img = document.createElement("img");
		img.src = "";
		img.style.zIndex = "-1";

		videoContainer.appendChild(img);
	}

	function elementBack() {
		img = null;

		toggleButton.innerText = "start";

		videoContainer.firstChild.remove();

		cameraOff.style.zIndex = "-1";

		cpuInfo.innerText = "disconnet";
		batInfo.innerText = "disconnet";
		fpsInfo.innerText = "disconnet";
		memInfo.innerText = "disconnet";
	}

	function close() {
		clearInterval(fpsCal);
		fpsCal = null;

		elementBack();

		ws.close();
		ws = null;
	}

	function wait(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}
</script>

</html>